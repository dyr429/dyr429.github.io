<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" href="styles.css">
<script src="https://www.gstatic.com/firebasejs/7.0.0/firebase.js"></script>

<style>

 text {
    fill: 'black';
    font-family: 'Arial';
    font-weight: bold;
    font-size: 28px;
  }


 h1{
    text-align: center;
 }

 h2{
    text-align: center;
 }

 h4{
    text-align: center
 }

 svg{
    border: 2px solid black;
    margin: auto;
    display: block;
 }

</style>
<body>

    <h1>Test your FPS game aming skill</h1>
    <h4 id="status">current level: 1 </h4>


<div id="instruciton" class="modal">

  <!-- Modal content -->
  <div class="modal-content">
    <h2>Instruction</h2>
    <p>Click the circle, there are 7 levels. For each level, you have only one chance on each level.</p>
    <p>enter your code:</p> 
    <input type="text" name="code" id="inputcode"/>
    <button onclick="checkcode()">OK</button>
  </div>
</div>

<div id="endgame" class="modal">

  <!-- Modal content -->
  <div class="modal-content">
    <h2>Thank you </h2>
    <p>You have completed this game, here is the verification code for Mechenical Turk</p>
    <p>your code is : 5678</p> 
    <button onclick="javascript:history.go(-1)">OK</button>
  </div>
</div>

<script src="https://d3js.org/d3.v4.min.js"></script>

<script>

    const firebaseConfig = {
        apiKey: "AIzaSyDLx2wggMZ_xrW6wY3SxBjzUrScwbyTNe8",
        authDomain: "mechanical-turk-fps-experiment.firebaseapp.com",
        databaseURL: "https://mechanical-turk-fps-experiment.firebaseio.com",
        projectId: "mechanical-turk-fps-experiment",
        storageBucket: "mechanical-turk-fps-experiment.appspot.com",
        messagingSenderId: "607114655443",
        appId: "1:607114655443:web:d3ee1c359b78e101858626",
        measurementId: "G-3KL2QEJG4V"
    };


    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    let database = firebase.database();

    function pushData(expid,data){

        database.ref().push({
            exp: data
        });
    }





    let result = {}
    let resultHit = [];
    let resultTime = [];
    let levelResult = {};
    let hitTimes = 0;
    let expCode;
    let timeStart;
    let timeEnd;


    let WIDTH = window.innerWidth;
    let HEIGHT = window.innerHeight;
    let SVGWIDTH = WIDTH -150;
    let SVGHEIGHT = HEIGHT -150
    let levels = [700,600,500,300,200,150,100,20]
    let level = 0;
    let currentX = WIDTH/2;
    let currentY = HEIGHT/2;
    let radius = 50;
    function nextX(){
        let offsetX = radius - Math.random()*radius*2
        if(currentX+offsetX>radius && currentX+offsetX<SVGWIDTH-radius)
            currentX = currentX + offsetX
        else
            currentX = currentX - offsetX
        return currentX
    }
    function nextY(){
        let offsetY = radius - Math.random()*radius*2
        if(currentY+offsetY>radius && currentY+offsetY<SVGHEIGHT-radius)
            currentY = currentY + offsetY
        else
            currentY = currentY - offsetY
        return currentY

    }

    let colors = ["red", "green","blue","yellow"]

    let svg = d3.select("body")
            .append("svg")
            .attr("width", SVGWIDTH)
            .attr("height", SVGHEIGHT);


    let timeCircle = svg.append("circle")
        .attr("fill", "yellow")
        .attr("stroke","black")
        .attr("stroke-width",3)
        .attr("r", 20)
    let index =-1
    function addTransition(){
        // let datalen = levelDataSet[level]["x"].length;
        //  index++;
         timeCircle.transition()
            .ease(d3.easeLinear)
            .duration(levels[level])
            .attr('cx', nextX())
            .attr('cy', nextY())
            .on("end", addTransition);
    }
    addTransition()

    let endgamemModal = document.getElementById("endgame");

    d3.selectAll("circle")
          .on("mousedown", function(){
            if(level === levels.length-2){
                let duration = new Date() - timeStart;
                timeStart = new Date();
                resultHit.push(hitTimes);
                resultTime.push(duration);
                result.hits = resultHit;
                result.duration = resultTime;
                result.expcode = expCode;
                pushData(expCode,result);
                endgamemModal.style.display = "block";
            }
            else if(level === 0){
                timeStart = new Date();
                let statusString = "current level: " + (level+1);
                document.getElementById("status").innerHTML = statusString
                d3.select(this)
                .attr("fill", colors[level%4]);


                currentX = Math.random()*(SVGWIDTH-radius) + radius;
                currentY = Math.random()*(SVGHEIGHT-radius) + radius;;
                 timeCircle.transition()
                    .ease(d3.easeLinear)
                    .duration(20)
                    .on("end", addTransition)
                    .attr('cx', currentX)
                    .attr('cy', currentY)


                hitTimes = 0;
                console.log("hit")
            }
            else{
                let duration = new Date() - timeStart;
                timeStart = new Date();
                let statusString = "current level: " + (level+1);
                document.getElementById("status").innerHTML = statusString
                d3.select(this).attr("fill", colors[level%4]);
                currentX = Math.random()*(SVGWIDTH-radius) + radius;;
                currentY = Math.random()*(SVGHEIGHT-radius) + radius;;
                 timeCircle.transition()
                    .ease(d3.easeLinear)
                    .duration(20)
                    .on("end", addTransition)
                    .attr('cx', currentX)
                    .attr('cy', currentY)

                resultHit.push(hitTimes);
                resultTime.push(duration);
                hitTimes = 0;
                console.log("hit")
                
            }
             
          level++;
    });

    d3.selectAll("svg")
          .on("mousedown", function(){
            hitTimes++;
    });



// Get the modal
let instructionModal = document.getElementById("instruciton");
instructionModal.style.display = "block";


function checkcode(){
    let code = document.getElementById("inputcode").value
    if(code % 100 === 0){
        expCode = code;
        instructionModal.style.display = "none";
    }else{
        alert("wrong code")
    }
}

    


</script>
</body>